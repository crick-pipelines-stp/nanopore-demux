process {
    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        mode: "${params.publish_dir_mode}",
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]
}

process {
    withName: 'SAMPLESHEET_CHECK' {
        publishDir = [
            path: { "${params.outdir}/pipeline_info" },
            mode: "${params.publish_dir_mode}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'DORADO_BASECALLER' {
        ext.args = "--device \"${params.dorado_device}\" ${params.dorado_both_ends ? '--barcode-both-ends' : ''}"
        ext.bc_kit = "${params.dorado_bc_kit == null ? '' : '--kit-name ' +  params.dorado_bc_kit}"
        containerOptions = { "${params.dorado_device == 'cpu' ? '' : '--gpus all' }" }
        publishDir = [
            path: { "${params.outdir}/dorado/basecaller" },
            mode: "${params.publish_dir_mode}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'DORADO_DEMUX' {
        ext.args = "${params.emit_bam ? '' : '--emit-fastq' }"

        publishDir = [
            path: { "${params.outdir}/dorado/demux" },
            mode: "${params.publish_dir_mode}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'CHOPPER' {
        ext.args2 = "-q ${params.min_qscore}" 

        publishDir = [
            path: { "${params.outdir}/${meta.group}/${meta.user}/${meta.project_id}/${meta.run_id}/filtered_reads_chopper" },
            mode: "${params.publish_dir_mode}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'SAMTOOLS_VIEW' {
        ext.args2 = "-q ${params.min_qscore}" 

        publishDir = [
            path: { "${params.outdir}/${meta.group}/${meta.user}/${meta.project_id}/${meta.run_id}/filtered_reads_samtools" },
            mode: "${params.publish_dir_mode}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'FASTQC' {
        publishDir = [
            path: { "${params.outdir}/${meta.group}/${meta.user}/${meta.project_id}/${meta.run_id}/fastqc" },
            mode: "${params.publish_dir_mode}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'NANOPLOT' {
        publishDir = [
            path: { "${params.outdir}/${meta.group}/${meta.user}/${meta.project_id}/${meta.run_id}/nanoplot" },
            mode: "${params.publish_dir_mode}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'PYCOQC' {
        publishDir = [
            path: { "${params.outdir}/pycoqc" },
            mode: "${params.publish_dir_mode}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'MULTIQC' {
        publishDir = [
            path: { "${params.outdir}/multiqc" },
            mode: "${params.publish_dir_mode}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'MULTIQC_USER' {
        publishDir = [
            path: { "${params.outdir}/${meta.group}/${meta.user}/${meta.project_id}/${meta.run_id}/multiqc" },
            mode: "${params.publish_dir_mode}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}